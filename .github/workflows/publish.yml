name: Publish to NPM

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        default: true
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Setup Zig
        run: |
          curl -L https://ziglang.org/builds/zig-x86_64-linux-0.16.0-dev.1859+212968c57.tar.xz -o zig.tar.xz
          tar -xf zig.tar.xz
          mv zig-x86_64-linux-0.16.0-dev.1859+212968c57 zig
          echo "$PWD/zig" >> $GITHUB_PATH

      - name: Verify Zig
        run: zig version

      - name: Build pantry from source
        run: |
          git clone --depth 1 https://github.com/home-lang/pantry.git ../pantry
          cd ../pantry/packages/zig
          mkdir -p pantry
          cd pantry
          git clone --depth 1 https://github.com/zig-utils/zig-cli.git
          git clone --depth 1 https://github.com/zig-utils/zig-config.git
          git clone --depth 1 https://github.com/zig-utils/zig-test-framework.git

      - name: Patch zig-config for Zig 0.16
        run: |
          cd ../pantry/packages/zig/pantry/zig-config
          # Fix std.fs.cwd().realpath -> std.posix.getcwd for Zig 0.16
          sed -i 's/std\.fs\.cwd()\.realpath("\.", &cwd_buf)/std.posix.getcwd(\&cwd_buf)/g' src/config_loader.zig
          # Add io helper for file_loader.zig (insert after first line)
          sed -i '1a\var io_instance: std.Io.Threaded = .init_single_threaded;\nfn getIo() std.Io { return io_instance.io(); }' src/services/file_loader.zig
          # Fix std.fs.accessAbsolute -> std.Io.Dir.accessAbsolute
          sed -i 's/std\.fs\.accessAbsolute(path, \.{})/std.Io.Dir.accessAbsolute(getIo(), path, .{})/g' src/services/file_loader.zig
          # Fix std.fs.openFileAbsolute -> std.Io.Dir.openFileAbsolute
          sed -i 's/std\.fs\.openFileAbsolute(path, \.{})/std.Io.Dir.openFileAbsolute(getIo(), path, .{})/g' src/services/file_loader.zig
          # Fix file.read -> std.posix.read
          sed -i 's/file\.read(&buf)/std.posix.read(file.handle, \&buf)/g' src/services/file_loader.zig
          # Fix file.close() -> file.close(getIo())
          sed -i 's/file\.close()/file.close(getIo())/g' src/services/file_loader.zig

      - name: Patch pantry for Zig 0.16 libc
        run: |
          cd ../pantry/packages/zig
          # Fix std.c.lseek -> std.posix.system.lseek in io_helper.zig
          sed -i 's/std\.c\.lseek/std.posix.system.lseek/g' src/io_helper.zig
          # Fix std.c.fchmod -> std.posix.system.fchmod in shim.zig
          sed -i 's/std\.c\.fchmod/std.posix.system.fchmod/g' src/cli/commands/shim.zig

      - name: Compile pantry
        run: |
          cd ../pantry/packages/zig
          zig build
          echo "$PWD/zig-out/bin" >> $GITHUB_PATH

      - name: Publish (Dry Run)
        if: ${{ inputs.dry_run == true }}
        run: pantry publish --dry-run --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish
        if: ${{ inputs.dry_run == false }}
        run: pantry publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
